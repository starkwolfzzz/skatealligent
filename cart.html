<?php
require('php/functions.php');

if (!isset($_COOKIE["session"]) || checkSession($_COOKIE["session"]) == "session is incorrect") {
    header("location: http://skatealligent.tk/login.html?redirect=" . (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? "https" : "http") . "://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]");
}
?>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="color-scheme" content="dark">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skate Alligent - Cart</title>
    <link rel="icon" type="image/png" href="images/Icon.png">
    <link rel="stylesheet" href="css/style.css">
    <link href="fontawesome-free-5.15.3-web/css/all.css" rel="stylesheet">
</head>

<body>
    <div class="font_credit">Font made from <a href="http://www.onlinewebfonts.com">oNline Web Fonts</a> is licensed by CC BY 3.0</div>
    <meta name="color-scheme" content="dark">
    <script src="https://unpkg.com/ionicons@5.5.1/dist/ionicons.js"></script>
    <div class="header">
        <div class="container">
            <div class="navbar2" id="headerr" style="background-color: #160a22; position: inherit;">
                <div class="logo-noline" id="logo">
                    <a style="color: white;" class="logo" href="/">Skate Alligent</a>
                </div>
                <nav>
                    <ul id="menuItems">
                        <li><a href="/">Home</a></li>
                        <li><a href="/shop.html?pg=1">Shop</a></li>
                        <li><a href="/account.html">Account</a></li>
                        <li><a href="/contact.html">Contact</a></li>
                        <li><a href="/about.html">About</a></li>
                    </ul>
                </nav>
                <a href="/cart.html" class="button" id="Active"><i class="fas fa-shopping-cart" aria-hidden="true" style="transform: scale(0.8); transition: 0.5s ease"></i></a>
                <a class="menu-icon" onclick="menuToggle()"><i class="fas fa-bars" aria-hidden="true" style="transform: scale(0.8)"></i></a>
            </div>
        </div>
    </div>

    <!--- Cart --->
    <div class="small-container cart-pg">
        <div class="row" id="hidden-empty" style="display: none;">
            <a style="margin: 200px; margin-top: 120px; margin-bottom: -180px; font-weight: bolder; font-size: 30px;">YOUR CART IS EMPTY</a>
            <a href="shop.html?pg=1" class="cart-btn" style=" margin: 200px; cursor: pointer; border: 1px solid white; background-color: white; color: black; padding: 13px; width: 15%;">Add More Items</a>
        </div>
        <table class="cart-table">
            <tr>
                <th style="border-right: none;">Product</th>
                <th style="border-right: none; border-left: none;">Quantity</th>
                <th style="border-left: none;">Subtotal</th>
            </tr>
            <?php
            require('php/connection.php');

            $session = $_COOKIE['session'];

            $sql = "SELECT * FROM users WHERE session = '" . $session . "';";
            $query = mysqli_query($conn, $sql);
            $rows = mysqli_num_rows($query);

            $cartList;
            $quanList;
            $id;

            if ($rows == 1) {
                while ($row = mysqli_fetch_assoc($query)) {
                    $id = $row['id'];
                    $cartList = explode(", ", $row['cart']);
                    $quanList = explode(", ", $row['cartCount']);
                }
            }

            if ($cartList[0] != "") {
                for ($i = 0; $i < count($cartList); $i++) {
                    $sqli = "SELECT * FROM Products WHERE ID = '" . $cartList[$i] . "';";
                    $queryi = mysqli_query($conn, $sqli);
                    $rowsi = mysqli_num_rows($queryi);

                    if ($rowsi > 0) {
                        while ($rowi = mysqli_fetch_assoc($queryi)) {
                            echo '<tr class="item-cell">';
                            echo '<td>';
                            echo '<div class="cart-info">';
                            echo '<img src="products/' . $rowi['ID'] . '.png" style="cursor: pointer;" onclick="switchPg(' . "'/product.html?id=" . $rowi['ID'] . "'" . ')">';
                            echo '<div>';
                            echo '<a style="cursor: pointer;" href="/product.html?id=' . $rowi['ID'] . '" id="link">' . $rowi['Name'] . '</a>';
                            echo '<br>';
                            echo "<a class='prodid' style='display: none';>" . $rowi['ID'] . "</a>";
                            echo "<a class='productStock' style='display: none';>" . $rowi['Stock'] . "</a>";
                            echo '<small>EGP ' . intval($rowi['Price']) . '</small>';
                            echo '<br>';
                            echo '<small class="discount">Discount: EGP ' . intval($rowi['Sale']) . '</small>';
                            echo '<br>';
                            echo '</div>';
                            echo '</div>';
                            echo '</td>';
                            echo '<td>';
                            echo '<input type="number" value="' . $quanList[$i] . '" min="1" max="100" class="inputQuan" onfocusout="inputValueCheck(' . $i . ')"> &nbsp;';
                            echo '<a class="remove-btns" id="link" onclick="removeItem(' . $i . ', ' . "'btn'" . ')">Remove</a> &nbsp;';
                            echo '</td>';
                            echo '<td>EGP ' . intval($rowi['Price'] * $quanList[$i]) . '</td>';
                            echo '</tr>';
                        }
                    }
                }

                echo "<a id='userid' style='display: none';>" . $id . "</a>";
            }
            ?>
        </table>
        <div class="total-price">
            <table>
                <tr>
                    <td>Subtotal</td>
                    <td>EGP 0.00</td>
                </tr>
                <tr>
                    <td>Discount</td>
                    <td>EGP 0.00</td>
                </tr>
                <tr>
                    <td>Total</td>
                    <td>EGP 0.00</td>
                </tr>
                <tr>
                    <td></td>
                </tr>
                <tr>
                    <td class="cart-btn" style="background-color: rgba(15,86,132,1); border: 1px solid rgba(15,86,132,1);" onclick="switchPg('/shop.html?pg=1')">&#8592; Continue Shopping</td>
                    <td class="cart-btn" style="background-color: rgba(42, 184, 88, 1); border: 1px solid rgba(42, 184, 88, 1);" onclick="switchPg('/checkout.html')">Checkout &#8594;</td>
                </tr>
            </table>
        </div>
    </div>

    <!--- Cookie Notice --->
    <div class="cookies">
        <div class="container">
            <div class="row">
                <div class="col-2" style="text-align: right;">
                    <p>We use cookies to enhance your experience with our website.</p>
                    <p>By continuing to use the site, you agree to the use of cookies.</p>
                </div>
                <div class="col-2" style="text-align: left;">
                    <a class="cookie-btn" id="link" onclick="acceptCookies()">Accept Cookies</a>
                    <a class="cookie-btn" id="link" href="/cookie-policy.html" style="color: white;">Learn More</a>
                </div>
            </div>
        </div>
    </div>


    <!--- Footer --->
    <div class="footer" id="sec4">
        <div class="container">
            <div class="row">
                <div class="footer-col-1">
                    <img src="images/Logo.png" style="cursor: pointer;" onclick="switchPg('/index.html')">
                </div>
                <div class="footer-col-2">
                    <h3>Useful Links</h3>
                    <ul>
                        <li><a href="/account.html" style="color: #8a8a8a;" id="link">My Account</a></li>
                        <li><a href="/cart.html" style="color: #8a8a8a;" id="link">Shopping Cart</a></li>
                        <li><a href="/refund-policy.html" style="color: #8a8a8a;" id="link">Refund Policy</a></li>
                        <li><a href="/about.html" style="color: #8a8a8a;" id="link">About</a></li>
                    </ul>
                </div>
                <div class="footer-col-3">
                    <h3>Follow Us</h3>
                    <ul>
                        <li><a href="" style="color: #8a8a8a;" id="link">Facebook</a></li>
                        <li><a href="" style="color: #8a8a8a;" id="link">Instagram</a></li>
                        <li><a href="" style="color: #8a8a8a;" id="link">Twitter</a></li>
                        <li><a href="" style="color: #8a8a8a;" id="link">Youtube</a></li>
                    </ul>
                </div>
            </div>
            <hr>
            <p class="copyright">Copyright Â© 2021 Skate Alligent. All rights reserved. <a class="link" href="/terms-of-use.html">Terms of use </a> | <a class="link" href="/privacy-policy.html"> Privacy Policy</a>
            </p>
        </div>
    </div>

    <div class="form-overlay" style="position: fixed;">
        <div class="overlay-bg"></div>
        <img src="images/loading.png" class="loading">
    </div>

    <!--- JavaScript --->
    <script>
        // <-- Menu -->
        var MenuItems = document.getElementById("menuItems");

        MenuItems.style.maxHeight = "0px";

        function menuToggle() {
            if (MenuItems.style.maxHeight == "0px") {
                MenuItems.style.maxHeight = "200px";
            } else {
                MenuItems.style.maxHeight = "0px";
            }
        }

        // <-- Products Href -->
        function prodPg() {
            location.href = "/product.html?id=" + "id";
        }

        // <-- Switch Page -->
        function switchPg(pg) {
            location.href = pg;
        }

        // <-- Input Value -->
        function inputValueCheck(n) {
            let input = document.getElementsByClassName("inputQuan");

            if (input[n].value == 0) {
                removeItem(n, "input");

                let inputs = document.getElementsByClassName("inputQuan");
                for (i = 0; i < inputs.length; i++) {
                    inputs[i].setAttribute("onChange", 'inputValueCheck(' + i + ')');
                }
            }

            let productStock = document.getElementsByClassName('productStock');
            var x = parseInt(productStock[n].innerHTML);
            if (x > 100) {
                if (input[n].value > 100) {
                    input[n].value = '100';
                } else if (input[n].value < 1) {
                    input[n].value = '1';
                } else if (input[n].value.toString().includes(".")) {
                    input[n].value = input[n].value.toString().substr(0, input[n].value.toString().indexOf("."))
                }
            } else {
                if (input[n].value > x) {
                    input[n].value = '' + x + '';
                } else if (input[n].value < 1) {
                    input[n].value = '1';
                } else if (input[n].value.toString().includes(".")) {
                    input[n].value = input[n].value.toString().substr(0, input[n].value.toString().indexOf("."))
                }
            }

            let prodid = document.getElementsByClassName("prodid")[n].textContent;
            let id = document.getElementById("userid");
            loading(true);

            var form_data = new FormData();

            form_data.append("cartQuanUId", id.innerHTML);
            form_data.append("cartQuanID", prodid);
            form_data.append("cartQuant", input[n].value);

            var ajax_request = new XMLHttpRequest();

            ajax_request.open('POST', 'php/process_data.php');

            ajax_request.send(form_data);

            ajax_request.onreadystatechange = function() {
                if (ajax_request.readyState == 4 && ajax_request.status == 200) {

                    var response = ajax_request.responseText;

                    if (response == "Changed Quantity") {
                        loading(false);
                        location.reload();
                    } else {
                        loading(false);
                    }
                }
            }
        }

        // <-- Remove Item -->
        function removeItem(n, type) {
            let parents = document.getElementsByClassName("item-cell");
            let prodid = document.getElementsByClassName("prodid")[n].textContent;
            let id = document.getElementById("userid");
            let input = document.getElementsByClassName("inputQuan")[n].value;
            loading(true);

            var form_data = new FormData();

            form_data.append("cartItemId", id.innerHTML);
            form_data.append("cartItemID", prodid);
            form_data.append("cartItemQuan", input);

            var ajax_request = new XMLHttpRequest();

            ajax_request.open('POST', 'php/process_data.php');

            ajax_request.send(form_data);

            ajax_request.onreadystatechange = function() {
                if (ajax_request.readyState == 4 && ajax_request.status == 200) {

                    var response = ajax_request.responseText;

                    if (response == "removed from cart") {
                        loading(false);
                        location.reload();
                    } else {
                        loading(false);
                    }
                }
            }
        }

        // <-- Prices and stuff -->
        function changePrices(n, n2) {
            let parent = document.getElementsByClassName("item-cell");
            var text = parent[n2].children[0].children[0].children[1].children[4].textContent;
            var x = parseInt(parseInt(parent[n2].children[0].children[0].children[1].children[4].textContent.substring('EGP '.length, text.length)) * n);
            if (x.toString().length <= 2) {
                parent[n2].children[2].textContent = "EGP " + parseInt(x) + ".00";
            } else if (x.toString().length > 2) {
                parent[n2].children[2].textContent = "EGP " + parseInt(x);
            }
            updateTotals();
        }

        // <-- Totals -->
        updateTotals();

        function updateTotals() {
            let parentt = document.getElementsByClassName("total-price");
            let Subtotall = parentt[0].children[0].children[0].children[0].children[1];
            let discountt = parentt[0].children[0].children[0].children[1].children[1];
            let Totall = parentt[0].children[0].children[0].children[2].children[1];
            let cons = document.getElementsByClassName("item-cell");
            var numbers = [];
            var subtotal = 0;
            var discounts = document.getElementsByClassName("discount");
            var discount = 0;

            for (i = 0; i < discounts.length; i++) {
                var mul = cons[i].children[2].innerHTML.substr("EGP ".length) / cons[i].children[0].children[0].children[1].children[4].textContent.substr("EGP ".length);
                discount += parseInt(discounts[i].innerHTML.substr("Discount: EGP ".length)) * mul;
            }

            for (i = 0; i < cons.length; i++) {
                numbers.push(cons[i].children[2].textContent.substr("EGP ".length));
            }

            for (i = 0; i < numbers.length; i++) {
                subtotal += parseInt(numbers[i]);
            }

            Subtotall.textContent = "EGP " + subtotal;
            discountt.textContent = "EGP " + discount;
            Totall.textContent = "EGP " + parseInt(subtotal - discount);
        }

        // <-- Check If Empty -->
        checkIfEmpty();

        function checkIfEmpty() {
            let parents = document.getElementsByClassName("item-cell");
            if (parents.length == 0) {
                let totals = document.getElementsByClassName("total-price");
                let table = document.getElementsByClassName("cart-table");
                totals[0].remove();
                table[0].remove();

                let row = document.getElementById("hidden-empty");
                row.style.display = "flex";
            }
        }

        // <-- Cookie Consent -->
        let cSection = document.getElementsByClassName("cookies");
        let cCont = cSection[0].children[0];
        checkCookies();

        function checkCookies() {
            if (getCookie("CookieConsent") == null) {
                cFunc("show");
            } else {
                cFunc("hide");
            }
        }

        function acceptCookies() {
            cFunc("hide");
            setCookie("CookieConsent", "true");
        }

        function cFunc(n) {
            if (n == "show") {
                cCont.style.top = parseInt(parseInt(window.innerHeight) - 80) + "px";
            } else if (n == "hide") {
                cCont.style.top = window.innerHeight + "px";
            }
        }

        function setCookie(key, value) {
            var expires = new Date();
            expires.setTime(expires.getTime() + (10000 * 365 * 24 * 60 * 60));
            document.cookie = key + '=' + value + ';expires=' + expires.toUTCString();
        }

        function getCookie(key) {
            var keyValue = document.cookie.match('(^|;) ?' + key + '=([^;]*)(;|$)');
            return keyValue ? keyValue[2] : null;
        }

        function loading(con, n = 0) {
            if (con == true) {
                document.getElementsByClassName("form-overlay")[n].classList.add("ovlyact");
            } else {
                document.getElementsByClassName("form-overlay")[n].classList.remove("ovlyact");
            }
        }
    </script>
</body>

</html>